<!-- app/templates/users.html -->

{% extends "base.html" %}

{% block title %}
Users - School Management App
{% endblock %}

{% block content %}
<h2>Users</h2>
<form method="GET" action="{{ url_for('main.users') }}">
    <input type="text" name="search" value="{{ search }}" placeholder="Search by last name...">
    <button type="submit">Search</button>
</form>

<form method="POST" action="{{ url_for('main.users') }}">
    {{ advanced_search_form.hidden_tag() }}
    <div>
        {{ advanced_search_form.grade.label }} {{ advanced_search_form.grade() }}
    </div>
    <div>
        {{ advanced_search_form.ethnic_origin.label }} {{ advanced_search_form.ethnic_origin() }}
    </div>
    <div>
        {{ advanced_search_form.search_empty_fields.label }} {{ advanced_search_form.search_empty_fields() }}
    </div>
    <button type="submit">Advanced Search</button>
</form>

<a href="{{ url_for('main.new_user') }}">Create New User</a>

<form method="POST" action="{{ url_for('main.batch_update') }}">
    {{ form.hidden_tag() }}  <!-- Include the CSRF token -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Select</th>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Role</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td><input type="checkbox" name="user_ids" value="{{ user.id }}" class="user-checkbox"></td>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.first_name }}</td>
                    <td>{{ user.last_name }}</td>
                    <td>{{ user.role.name }}</td>
                    <td>
                        <a href="{{ url_for('main.edit_user', user_id=user.id) }}">Edit</a>
                        <form action="{{ url_for('main.delete_user', user_id=user.id) }}" method="post" style="display:inline;">
                            <button type="submit">Delete</button>
                        </form>
                        <a href="{{ url_for('main.user_profile', user_id=user.id) }}">Profile</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div>
        {{ form.set_age.label }} {{ form.set_age() }}
    </div>
    <div>
        {{ form.set_grade.label }} {{ form.set_grade() }}
    </div>
    <button type="submit">Batch Update</button>
</form>
<div class="pagination-container">
    <ul class="pagination">
        {% if pagination.has_prev %}
        <li><a href="{{ url_for('main.users', page=pagination.prev_num, per_page=per_page, search=search) }}">&laquo;</a></li>
        {% endif %}
        {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
        <li class="{% if page_num == pagination.page %}active{% endif %}">
            <a href="{{ url_for('main.users', page=page_num, per_page=per_page, search=search) }}">{{ page_num }}</a>
        </li>
        {% else %}
        <li><span class="ellipsis">â€¦</span></li>
        {% endif %}
        {% endfor %}
        {% if pagination.has_next %}
        <li><a href="{{ url_for('main.users', page=pagination.next_num, per_page=per_page, search=search) }}">&raquo;</a></li>
        {% endif %}
    </ul>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Retrieve selected user IDs from local storage
        const selectedUserIds = JSON.parse(localStorage.getItem('selectedUserIds')) || [];

        // Restore checkbox selections
        document.querySelectorAll('.user-checkbox').forEach(checkbox => {
            if (selectedUserIds.includes(checkbox.value)) {
                checkbox.checked = true;
            }

            // Add event listener to update local storage when checkbox is clicked
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    selectedUserIds.push(this.value);
                } else {
                    const index = selectedUserIds.indexOf(this.value);
                    if (index > -1) {
                        selectedUserIds.splice(index, 1);
                    }
                }
                localStorage.setItem('selectedUserIds', JSON.stringify(selectedUserIds));
            });
        });

        // Add hidden inputs for selected user IDs to the batch update form
        const batchUpdateForm = document.querySelector('form[method="POST"]');
        selectedUserIds.forEach(userId => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'user_ids';
            input.value = userId;
            batchUpdateForm.appendChild(input);
        });
    });
</script>
{% endblock %}
